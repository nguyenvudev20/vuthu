<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Slideshow Fullscreen + Nhạc nền</title>
  <style>
    :root { --bg:#0b0c10; --ui:#10121a; --fg:#f1f3f9; --muted:#a7adbb; --accent:#ff82b2; }
    * { box-sizing: border-box; }
    html, body { height: 100%; margin: 0; background: var(--bg); color: var(--fg); font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }

    /* Stage */
    #stage { position: fixed; inset: 0; overflow: hidden; background: radial-gradient(1200px 800px at 70% 30%, #0f1320, #090a0f 70%); }
    .slide { position: absolute; inset: 0; display: grid; place-items: center; opacity: 0; transition: opacity 800ms ease; }
    .slide.active { opacity: 1; }
    .slide img { width: 100vw; height: 100vh; object-fit: cover; }

    /* Top overlay */
    .topbar { position: fixed; left: 0; right: 0; top: 0; display: flex; gap: 8px; align-items: center; padding: 8px 10px; background: linear-gradient(180deg, rgba(8,10,18,.75), rgba(8,10,18,0)); z-index: 10; }
    .spacer { flex: 1; }
    .btn { appearance: none; border: 1px solid #2a3144; background: #121523; color: var(--fg); padding: 8px 12px; border-radius: 12px; cursor: pointer; font-weight: 600; }
    .btn:hover { filter: brightness(1.08); }
    .file { display: none; }
    .file-label { cursor: pointer; }
    .muted { color: var(--muted); font-size: 12px; }

    /* Help hint */
    .hint { position: fixed; right: 12px; bottom: 12px; background: rgba(0,0,0,.45); border: 1px solid rgba(255,255,255,.08); padding: 8px 10px; border-radius: 10px; font-size: 12px; z-index: 10; }

    /* Start overlay for autoplay */
    #startOverlay { position: fixed; inset: 0; display: grid; place-items: center; background: radial-gradient(1200px 800px at 70% 30%, rgba(14,16,26,.95), rgba(6,7,12,.98)); z-index: 20; }
    #startOverlay .card { text-align: center; background: #121523; border: 1px solid #2a3144; padding: 24px; border-radius: 16px; box-shadow: 0 10px 40px rgba(0,0,0,.45); }
    #startOverlay h1 { margin: 0 0 8px; font-size: 20px; }
    #startOverlay p { margin: 0 0 16px; color: var(--muted); }

    /* Progress */
    .progress { position: fixed; left: 50%; transform: translateX(-50%); bottom: 10px; width: min(60vw, 520px); height: 4px; border-radius: 999px; background: #20263a; overflow: hidden; z-index: 10; }
    .bar { height: 100%; width: 0%; background: linear-gradient(90deg, #ff82b2, #ffd27e); transition: width .2s linear; }

    @media (hover:none) { .hint { display: none; } }
  </style>
</head>
<body>
  <!-- UI -->
  <div class="topbar">
    <label class="btn file-label" for="files">+ Ảnh</label>
    <input id="files" class="file" type="file" accept="image/*" multiple>

    <label class="btn file-label" for="audio">♪ Nhạc nền</label>
    <input id="audio" class="file" type="file" accept="audio/*">

    <button id="btnPlay" class="btn">Bắt đầu</button>
    <button id="btnPause" class="btn">Tạm dừng</button>
    <button id="btnPrev" class="btn">◀</button>
    <button id="btnNext" class="btn">▶</button>
    <div class="spacer"></div>
    <label class="muted">Âm lượng <input id="vol" type="range" min="0" max="1" step="0.01" value="0.6"></label>
    <button id="btnFS" class="btn">⛶ Toàn màn hình</button>
  </div>

  <!-- Stage -->
  <main id="stage"></main>
  <div class="progress"><div class="bar" id="bar"></div></div>
  <div class="hint">Phím tắt: Space phát/tạm dừng • ←/→ chuyển ảnh • F fullscreen • M tắt tiếng</div>

  <!-- Autoplay guard overlay -->
  <div id="startOverlay">
    <div class="card">
      <h1>Slideshow + Nhạc nền</h1>
      <p>Tải ảnh & nhạc (hoặc dùng nhạc mặc định), sau đó bấm Bắt đầu.</p>
      <button class="btn" id="btnStartOverlay">Bắt đầu</button>
    </div>
  </div>

  <script>
  // ===== Config =====
  const DURATION_MS = 7000; // mỗi ảnh 7s
  const XFADE_MS = 800;     // mờ dần

  let images = [];     // [{url,name}]
  let idx = 0;         // index ảnh hiện tại
  let running = false; // trạng thái slideshow
  let timer = null;    // interval
  let progressTimer = null;

  const stage = document.getElementById('stage');
  const bar = document.getElementById('bar');
  const files = document.getElementById('files');
  const audioInput = document.getElementById('audio');
  const btnPlay = document.getElementById('btnPlay');
  const btnPause = document.getElementById('btnPause');
  const btnPrev = document.getElementById('btnPrev');
  const btnNext = document.getElementById('btnNext');
  const btnFS = document.getElementById('btnFS');
  const vol = document.getElementById('vol');
  const startOverlay = document.getElementById('startOverlay');
  const btnStartOverlay = document.getElementById('btnStartOverlay');

  const audio = new Audio();
  audio.loop = true;
  audio.volume = parseFloat(vol.value);

  const DEFAULT_AUDIO = [
    'audio/xứng đôi cưới thôi nhen.mp3',
    'audio/xung doi cuoi thoi nhen.mp3',
    'audio/xung-doi-cuoi-thoi-nhen.mp3'
  ];

  function setProgress(ms){ bar.style.width = Math.min(100, Math.max(0, 100*ms/DURATION_MS)) + '%'; }
  function clearStage(){ stage.querySelectorAll('.slide').forEach(el=> el.remove()); }

  function createSlide(url){
    const div = document.createElement('div');
    div.className = 'slide';
    const img = document.createElement('img');
    img.decoding = 'async';
    img.loading = 'eager';
    img.src = url;
    div.appendChild(img);
    return div;
  }

  function readImagesFromInput(list){
    images = [];
    for (const f of list){
      if (!f.type.startsWith('image/')) continue;
      const url = URL.createObjectURL(f);
      images.push({url, name: f.name});
    }
    idx = 0;
  }

  files.addEventListener('change', (e)=> {
    readImagesFromInput(e.target.files);
    if (images.length) showSlide(idx);
  });

  audioInput.addEventListener('change', (e)=>{
    const f = e.target.files?.[0]; if (!f) return;
    const url = URL.createObjectURL(f); audio.src = url; audio.play().catch(()=>{});
  });

  vol.addEventListener('input', ()=> audio.volume = parseFloat(vol.value));

  async function probeDefaultAudio(){
    for (const p of DEFAULT_AUDIO){
      const ok = await new Promise(res=>{ const a = new Audio(); a.preload='auto'; a.src = p; a.addEventListener('canplaythrough', ()=> res(true), {once:true}); a.addEventListener('error', ()=> res(false), {once:true}); });
      if (ok){ audio.src = p; return true; }
    }
    return false;
  }

  async function showSlide(i){
    if (!images.length) return;
    const item = images[i % images.length];
    const el = createSlide(item.url);
    stage.appendChild(el);
    await new Promise(res=>{ const img = el.querySelector('img'); if (img.complete) res(); else { img.onload = ()=> res(); img.onerror = ()=> res(); }});
    el.classList.add('active');
    const olds = Array.from(stage.querySelectorAll('.slide')).slice(0,-1);
    olds.forEach(o=>{ o.style.transition = `opacity ${XFADE_MS}ms ease`; o.style.opacity = 0; setTimeout(()=> o.remove(), XFADE_MS + 40); });
  }

  function startProgress(){
    let elapsed = 0; setProgress(0);
    clearInterval(progressTimer);
    progressTimer = setInterval(()=>{ if(!running) return; elapsed += 200; setProgress(elapsed); }, 200);
  }

  async function start(){
    if (!images.length){ alert('Hãy chọn ảnh trước.'); return; }
    running = true; clearStage(); await showSlide(idx); startProgress();
    clearInterval(timer);
    timer = setInterval(async ()=>{ if(!running) return; idx = (idx + 1) % images.length; await showSlide(idx); startProgress(); }, DURATION_MS);
    if (audio.src && audio.paused){ audio.play().catch(()=>{}); }
  }

  // Buttons
  btnPlay.addEventListener('click', start);
  btnPause.addEventListener('click', ()=>{ running = !running; btnPause.textContent = running ? 'Tạm dừng' : 'Tiếp tục'; if (audio.src){ running ? audio.play().catch(()=>{}) : audio.pause(); }});
  btnNext.addEventListener('click', async ()=>{ if(!images.length) return; running = false; idx = (idx+1)%images.length; await showSlide(idx); });
  btnPrev.addEventListener('click', async ()=>{ if(!images.length) return; running = false; idx = (idx-1+images.length)%images.length; await showSlide(idx); });

  btnFS.addEventListener('click', ()=>{
    const el = document.documentElement;
    if (!document.fullscreenElement){ el.requestFullscreen?.(); }
    else { document.exitFullscreen?.(); }
  });

  // Hotkeys
  window.addEventListener('keydown', (e)=>{
    if (e.key === ' ') { e.preventDefault(); btnPause.click(); }
    if (e.key === 'ArrowRight') btnNext.click();
    if (e.key === 'ArrowLeft') btnPrev.click();
    if (e.key.toLowerCase() === 'f') btnFS.click();
    if (e.key.toLowerCase() === 'm') audio.muted = !audio.muted;
  });

  // Drag & drop
  window.addEventListener('dragover', e=> e.preventDefault());
  window.addEventListener('drop', e=>{ e.preventDefault(); if (e.dataTransfer.files?.length){ readImagesFromInput(e.dataTransfer.files); if (images.length) showSlide(idx); }});

  // Autoplay policy guard
  btnStartOverlay.addEventListener('click', async ()=>{
    startOverlay.style.display = 'none';
    // Try default audio if none chosen
    if (!audio.src) await probeDefaultAudio();
    // if audio available, try play
    if (audio.src) audio.play().catch(()=>{});
  });

  // Optional: URL param ?auto=1 will try to auto start if user clicks overlay
  // (Cannot bypass overlay due to browser autoplay restrictions.)

  // Self-test minimal (no UI break)
  console.log('[self-test] captions not used, simple slideshow ready');
  </script>
</body>
</html>